<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>BHA with Real Depth Axis</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
</head>
<body style="margin:0">
  <div id="bhaDepthFix" style="width: 100%; height: 500px;"></div>

  <script>
    const chart = echarts.init(document.getElementById('bhaDepthFix'));
    let angle = 0;

    const components = [
      {
        name: 'Drillpipe',
        width: 200,
        color: '#A0A0A0',
        description: 'Transmits torque and fluid.',
        url: 'https://example.com/drillpipe',
        depth: 0
      },
      {
        name: 'Crossover Sub',
        width: 120,
        color: '#8888CC',
        description: 'Connects different tool joints.',
        url: 'https://example.com/crossover',
        depth: 1000
      },
      {
        name: 'Drill Collar',
        width: 200,
        color: '#FFD700',
        description: 'Adds weight on bit and stiffness.',
        url: 'https://example.com/drillcollar',
        depth: 3000
      },
      {
        name: 'Stabilizer',
        width: 160,
        color: '#32CD32',
        description: 'Centralizes BHA.',
        url: 'https://example.com/stabilizer',
        depth: 4000
      },
      {
        name: 'Reamer',
        width: 160,
        color: '#FF8C00',
        description: 'Enlarges/conditions borehole.',
        url: 'https://example.com/reamer',
        depth: 5000
      },
      {
        name: 'Bit',
        width: 180,
        color: '#DC143C',
        description: 'Breaks rock, drills formation.',
        url: 'https://example.com/bit',
        depth: 6000,
        isBit: true
      }
    ];

    function getRenderItem(rotationAngle) {
      return function (params, api) {
        const y = 180;
        const height = 60;
        const group = { type: 'group', children: [] };

        for (const comp of components) {
          const coord = api.coord([comp.depth, 0]); // get canvas X from depth
          const x = coord[0];
          const w = comp.width;

          let shape;
          if (comp.isBit) {
            shape = {
              type: 'group',
              rotation: (rotationAngle * Math.PI) / 180,
              origin: [x + w / 2, y + height / 2],
              children: [
                {
                  type: 'rect',
                  shape: { x, y, width: w, height: height - 10 },
                  style: { fill: comp.color, stroke: '#000' }
                },
                {
                  type: 'path',
                  shape: {
                    pathData: `
                      M${x},${y + height - 10}
                      L${x + w * 0.25},${y + height}
                      L${x + w * 0.5},${y + height - 5}
                      L${x + w * 0.75},${y + height}
                      L${x + w},${y + height - 10}
                      Z
                    `
                  },
                  style: { fill: comp.color, stroke: '#000' }
                }
              ]
            };
          } else {
            shape = {
              type: 'rect',
              shape: { x, y, width: w, height: height },
              style: { fill: comp.color, stroke: '#000' }
            };
          }

          group.children.push(
            {
              ...shape,
              info: {
                name: comp.name,
                description: comp.description,
                url: comp.url
              }
            },
            {
              type: 'text',
              style: {
                text: comp.name,
                x: x + w / 2,
                y: y + height / 2,
                textAlign: 'center',
                textVerticalAlign: 'middle',
                font: 'bold 12px sans-serif',
                fill: '#000'
              }
            }
          );
        }

        return group;
      };
    }

    const option = {
      title: {
        text: 'BHA with Depth Axis (Interactive + Animated)',
        left: 'center'
      },
      tooltip: {
        trigger: 'item',
        formatter: function (params) {
          const info = params?.data?.info;
          return info ? `<b>${info.name}</b><br/>${info.description}` : '';
        }
      },
      xAxis: {
        name: 'Depth (ft)',
        type: 'value',
        min: 0,
        max: 7000,
        axisLine: { show: true },
        splitLine: { show: true }
      },
      yAxis: {
        show: false,
        type: 'value',
        min: 0,
        max: 500
      },
      series: [
        {
          type: 'custom',
          coordinateSystem: 'cartesian2d',
          renderItem: getRenderItem(angle),
          data: components
        }
      ]
    };

    chart.setOption(option);

    // Animate bit rotation
    setInterval(() => {
      angle = (angle + 5) % 360;
      chart.setOption({
        series: [
          {
            type: 'custom',
            coordinateSystem: 'cartesian2d',
            renderItem: getRenderItem(angle),
            data: components
          }
        ]
      });
    }, 100);

    // Clickable shapes
    chart.getZr().on('click', function (event) {
      const pointInPixel = [event.offsetX, event.offsetY];
      const pointInGrid = chart.convertFromPixel({ seriesIndex: 0 }, pointInPixel);
      const xClicked = pointInGrid[0];

      const closest = components.find(c =>
        Math.abs(c.depth - xClicked) < 200
      );
      if (closest?.url) {
        window.open(closest.url, '_blank');
      }
    });
  </script>
</body>
</html>
